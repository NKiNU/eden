/*
 2013-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
(function(e,y){var w=0;e.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,defaultChartType:"linechart",defaultChartAxis:"totals"},_create:function(){this.id=w;w+=1},_init:function(){var a=e(this.element),b=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():
null;this.currentChart={type:null,chart:null,container:null};b.numberFormatter=function(d){var c=b.precision;if(null===d||"undefined"==typeof d)return"-";c=c||0==c?d.toFixed(c):d.toString();c=c.split(".");d=c[0];c=1<c.length?"."+c[1]:"";d=d.replace(new RegExp("\\B(?=(\\d{"+b.thousandGrouping+"})+(?!\\d))","g"),b.thousandSeparator);return d+c};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=
null;e.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=e(this.element),b=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var d=a.attr("id");a=e('<div class="pt-chart-opts">');var c=d+"-bchart-totals";d+="-lchart-totals";e(a).append(e('<span id="'+
d+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));e(a).append(e('<span id="'+c+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));e(b).append(a)}},_renderChart:function(a){var b=this.chart;if(b){var d=this.options,c=this.currentChart,f=null,h=null;a?(f=a.type,h=a.axis):(c&&(f=c.type,h=c.axis),f&&h||(f=d.defaultChartType,h=d.defaultChartAxis));c.type==f&&c.axis==h||this._removeChart();a=this.element;d=a.find(".tp-empty");c=this.data;
null===c&&(c=JSON.parse(this.input.val()));c||={e:!0};this.data=c;if(c.e)this._removeChart(),a.find(".tp-empty").show();else switch(d.hide(),b.show(),h){case "totals":switch(f){case "barchart":this._renderBarChart(b,c.f,c.p);break;default:this._renderLineChart(b,c.f,c.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,e(window).off("resize.tp"))},_renderBarChart:function(a,b,d){var c=[];for(b=0;b<d.length;b++){var f=
d[b];c.push({start:(new Date(f.t[0])).getTime(),value:f.v[0]})}d=this.currentChart;if(d.chart){var h=d.container;var l=d.chart;h.datum([{key:"reportChart",values:c}]).transition().duration(500).call(l)}else e(a).closest(".tp-chart-contents").show().css({width:"96%"}),e(a).css({height:"360px"}),h=d3.select(e(a).get(0)).append("svg").attr("class","nv"),l=nv.models.discreteBarChart().x(function(g){return g.start}).y(function(g){return g.value}).color(["silver"]).staggerLabels(!0).showValues(!0).forceY([0,
1]),l.tooltip.enabled(!1),a=this.options.numberFormatter,l.valueFormat(a),l.yAxis.tickFormat(a),l.xAxis.tickFormat(function(g){return(new Date(g)).toLocaleDateString()}),nv.addGraph(function(){h.datum([{key:"reportChart",values:c}]).transition().duration(500).call(l);e(window).off("resize.tp").on("resize.tp",function(g){l.update(g)});return l}),d.container=h,d.chart=l,d.type="barchart",d.axis="totals"},_renderLineChart:function(a,b,d){var c=[],f={},h=0,l=1==b.length,g;for(g=0;g<b.length;g++){var n=
b[g][0];f.hasOwnProperty(n)&&(h=f[n]+1);(f[n]=h)&&(n+=" ["+(h+1)+"]");var r={key:n,label:b[g][0],area:l},t=[];for(n=0;n<d.length;n++){var m=d[n];t.push({start:(new Date(m.t[0])).getTime(),value:m.v[g]})}r.values=t;c.push(r)}b=this.currentChart;if(b.chart){var k=b.container;var p=b.chart;k.datum(c).transition().duration(250).call(p)}else e(a).closest(".tp-chart-contents").show().css({width:"96%"}),e(a).css({height:"360px"}),k=d3.select(e(a).get(0)).append("svg").attr("class","nv"),p=nv.models.lineChart().x(function(q){return q.start}).y(function(q){return q.value}).margin({right:50}).duration(250).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),p.yAxis.tickFormat(this.options.numberFormatter),p.xAxis.tickFormat(function(q){return(new Date(q)).toLocaleDateString()}),nv.addGraph(function(){k.datum(c).transition().duration(500).call(p);e(window).off("resize.tp").on("resize.tp",function(q){p.update(q)});return p}),b.container=k,b.chart=p,b.type="linechart",b.axis="totals"},reload:function(a,b,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof b&&(b=this._getFilters());var c=this,f=!1;e(this.element).find(".tp-throbber").show();if(a||b)f=
this._updateAjaxURL(a,b);f||d?(a=this.options.ajaxURL,b=e.ajaxS3,e.searchS3!==y&&(b=e.searchS3),b({url:a,type:"GET",dataType:"json",success:function(h){c.input.val(JSON.stringify(h));c.data=h;c.refresh()},error:function(h,l,g){console.log("UNAUTHORIZED"==g?i18n.gis_requires_login:h.responseText)}})):c.refresh()},_getOptions:function(){var a="#"+e(this.element).attr("id"),b=e(a+"-time").val(),d=a=null,c=null;"custom"!=b&&(b=b.split("|"),3==b.length&&(a=b[0],d=b[1],c=b[2]));return{start:a,end:d,slots:c}},
_getFilters:function(){var a=e("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(b){return null}},_updateAjaxURL:function(a,b){var d=this.options.ajaxURL;if(!d)return!1;var c=d.split("?");if(1<c.length){var f=c[1];var h=f.split("&")}else f="",h=[];var l=[];d=!1;if(a)for(var g in a)f=a[g],f=g+"="+f,d||-1!=e.inArray(f,h)||(d=!0),l.push(f);g={};var n={},r;if(b){var t=function(p){var q,v,x=[];["contains","anyof","belongs","eq"].forEach(function(u){q=
new RegExp("__"+u+"$","g");p.match(q)?v=q:x.push(u)});v&&x.forEach(function(u){n[p.replace(v,"__"+u)]=!0})};f=0;for(r=b.length;f<r;f++){var m=b[f];var k=m[0];m=m[1];t(k);null===m?g[k]||(n[k]=!0):(n[k]&&(n[k]=!1),m=k+"="+encodeURIComponent(m),g[k]?g[k].push(m):g[k]=[m])}}f=0;for(r=h.length;f<r;f++)m=h[f].split("="),1<m.length&&(k=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),n[k]?d=!0:g[k]?d||-1!=e.inArray(k+"="+m,g[k])||(d=!0):a&&a.hasOwnProperty(k)||l.push(h[f]));for(k in g)for(f=0,r=g[k].length;f<
r;f++)d||-1!=e.inArray(g[k][f],h)||(d=!0),l.push(g[k][f]);a=l.join("&");b=c[0];a&&(b=b+"?"+a);this.options.ajaxURL=b;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,b="#"+this.widget_id;e(b+"-options legend").click(function(){e(this).siblings().toggle();e(this).children().toggle()});e(b+"-filters legend").click(function(){e(this).siblings().toggle();e(this).children().toggle()});e(b+"-time").on("change.autosubmit",function(){e(b+
"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var d=this.options.autoSubmit;e(b+"-tp-form").on("optionChanged",function(){var c=e(this);if(!c.data("noAutoSubmit")){var f=c.data("autoSubmitTimeout");f&&clearTimeout(f);f=setTimeout(function(){var h=a._getOptions(),l=a._getFilters();a.reload(h,l,!1)},d);c.data("autoSubmitTimeout",f)}})}else e(b+"-tp-form input.tp-submit").on("click.timeplot",function(){var c=a._getOptions(),f=a._getFilters();a.reload(c,f,!1)});e(b+"-lchart-totals").click(function(){a._renderChart({type:"linechart",
axis:"totals"})});e(b+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;e(window).off("resize.timeplot");e(a+"-tp-form").off("optionChanged");e(a+"-tp-form input.tp-submit").off("click.timeplot");e(a+"-time").unbind("change.autosubmit");e(a+"-options legend").unbind("click");e(a+"-filters legend").unbind("click");e(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
